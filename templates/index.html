{% extends "base.html" %}
{% block content %}
    <div class = "card">
        <!-- <div class = "card-title">     
            <img class = "main-dog"src="/static/img/dog_4.png">   
            <h1 id = "weather-fetch">WeatherWag</h1>
            <img class = "main-dog" id = "main-pup" src="/static/img/main_pup.png"/>
        </div> -->
        <!-- <p id = "phrase">Where Weather and Dog Care Wag Together</p> -->
        <!-- <p>The best walk is a safe walk</p> -->
        <form class = "mobile-form" method="POST" action="/">
            <div class = "mobile-user-input">
                <input type = "hidden" name = "timezone" id = "timezoneInput"/>
                <input type = "text" id ="city" name = "city" placeholder="Enter City" required/>
    
                <!-- <input type = "text" id = "state" name = "state" placeholder="Enter State" required> -->
                <select name = "states" required>
                    <option value ="">Select State</option>
                    {% for key, value in states.items() %} 
                        <option value ="{{ key }}">{{ value }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Submit</button>
            </div>
        </form>
            {% if error %}
        <p id="error">{{error}}</p>
    {% endif %}

        {% if weather %}
        <div class = "dog-message-section">

                {% if dog['color_message'] == "dark-red" or dog['color_message'] == "red" %}
                    <img id = "dog_3" src="/static/img/dog_3.png"/>
                {% else%}
                    <img id = "dog_1" src="/static/img/dog_1.png"/>
                {% endif %}

            <p id = "{{dog['color_message']}}">{{dog["dog_warning"]}}</p>

                {% if dog['color_message'] == "dark-red" or dog['color_message'] == "red" %}
                    <img id = "dog_4" src="/static/img/dog_4.png"/>
                {% else%}
                    <img id = "dog_2" src="/static/img/dog_2.png"/>
                {% endif %}

        </div>
        <div class = "weather-section">
            <div class = "card-section">
                <p id="user_city">{{weather["city"]}} {{state}}, US</p>
                <p>Last updated: {{weather["time"]}}</p>
                <img src="https://openweathermap.org/img/wn/{{ weather['icon'] }}@2x.png" alt="Weather Image"/>
                <p id = "temp">{{weather["temperature"]}}°</p>
                <p>Feels like {{weather["feels_temp"]}}°</p>
                <p>Humidity: {{weather["humidity"]}}%</p>
            </div>
            <div class = "card-section">
                <h3>Weather Details</h3>
                <p><b>Mainly:</b> {{weather["condition"]}}</p>
                <p><b>Description:</b> {{weather["description"]}}</p>
                <p><b>Wind:</b> {{weather["wind"]}}mph</p>
                <p><b>Wind Gust:</b> {{weather["wind_gust"]}}mph</p>
                <p><b>Sunrise:</b> {{weather["sunrise"]}}</p>
                <p><b>Sunset:</b> {{weather["sunset"]}}</p>
            </div>
            <div class = "card-section">
                <h3>Safety Dog Tip</h3>
                <p>{{dog['dog_tip_message'] | safe}}</p>
            </div>

        </div>
        <div class = "more-details">
            <div class = "card-section">
                <h3>Product Suggestions</h3>
                    <p id = "disclaimer">
                        As an Amazon Associate, I earn from qualifying purchases made through links on this site at no extra cost to you.
                    </p>
                    <br>
                <button id = "pre_btn" class = "product-button-left"><i class="bi bi-arrow-left"></i></button>
                <div>
                    <p id="product_name"></p>
                    <a id="product_link" href="" target="_blank" rel="noopener">
                        <img id="product_image" src="" alt="Product Image" />
                    </a>
                </div>
                <button id = "next_btn" class = "product-button-right"><i class="bi bi-arrow-right"></i></button>
            </div>
        </div> 
    {% endif %}

    <div id="map"> 

    </div>
    </div>
    <!-- <div class = "feedback">
        <button id = "feedback">Feedback</button>
    </div> -->

<script id="products-data" type="application/json">
  {{ product_recom | tojson | safe }}
</script>

<script>
    const productsScript = document.getElementById('products-data').textContent;
    const products = JSON.parse(productsScript);

    const product_name = document.getElementById('product_name');
    const product_image = document.getElementById('product_image');
    const product_link = document.getElementById('product_link');
    const next_btn = document.getElementById('next_btn');
    const pre_btn = document.getElementById('pre_btn')

    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    console.log("Your timezone is:", timezone);

    document.getElementById('timezoneInput').value = timezone;

    let current_index = 0
    

    function show_product(index) {
      const product = products[index];
      product_name.textContent = product.name;
      product_image.src = product.image_url || '/static/img/placeholder.png';
      product_link.href = product.affiliate_url;
    }
    show_product(current_index);

    next_btn.addEventListener('click', () => {
      current_index = (current_index+ 1) % products.length;
      show_product(current_index);
    });
    pre_btn.addEventListener('click', () => {
      current_index = (current_index- 1 + products.length) % products.length;
      show_product(current_index);
    });


  lucide.createIcons();
</script>
<script>
  (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
    key: "{{GOOGLE_API_KEY}}",
    v: "weekly",
    // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
    // Add other bootstrap parameters as needed, using camel case.
  });
</script>
<script>
    let map;
    let lat = parseFloat("{{location['lat']}}")
    let lng = parseFloat("{{location['lon']}}")
    let center =  { lat:lat, lng: lng};

async function initMap() {
  await google.maps.importLibrary("maps");
  await google.maps.importLibrary("marker");

  map = new google.maps.Map(document.getElementById("map"), {
    center,
    zoom: 10,
    mapId: "DEMO_MAP_ID",
  });

  addMarker();
}

async function addMarker() {
  const marker = new google.maps.marker.AdvancedMarkerElement({
    map,
    position: center,
  });
}

initMap();
</script>
{% endblock %}
